<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUNTA DE RETIRO Y FONDO DE PENSIONES</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; gap: 20px; flex-wrap: wrap; }
        .panel { background: white; padding: 20px; border-radius: 10px; width: 100%; max-width: 350px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid #0a2342; }
        h3 { color: #0a2342; font-family: 'Cinzel', serif; margin-top: 0; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #0a2342; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        button:hover { background: #003366; }
        
        /* Vista Previa Carnet */
        .carnet { width: 400px; height: 250px; background: white; border: 1px solid #ccc; position: relative; border-radius: 10px; overflow: hidden; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .header { background: #0a2342; height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 3px solid #c5a059; }
        .header img { width: 40px; margin-right: 10px; }
        .header h1 { color: white; font-size: 10px; font-family: 'Cinzel', serif; margin: 0; }
        .body-c { padding: 15px; display: flex; justify-content: space-between; }
        .data label { font-size: 8px; color: #888; display: block; text-transform: uppercase; }
        .data span { font-size: 14px; color: #0a2342; font-weight: bold; display: block; margin-bottom: 10px; border-bottom: 1px solid #eee; width: 150px;}
        .qr-box { border: 1px solid #ddd; padding: 5px; border-radius: 5px; }
        .badge { position: absolute; right: 10px; top: 10px; background: #c5a059; color: #0a2342; font-size: 10px; padding: 2px 5px; font-weight: bold; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="panel">
        <h3>Datos del Militar</h3>
        <input type="text" id="num" placeholder="N° Carnet (Ej: 2024-01)">
        <input type="text" id="rango" placeholder="Rango (Ej: CAPITÁN)">
        <input type="text" id="nombre" placeholder="Nombre Completo">
        <input type="text" id="cedula" placeholder="Cédula (Ej: 001-000...)">
        <button onclick="generar()" id="btn">GENERAR CARNET</button>
        <p id="msg" style="font-size: 12px; text-align: center; margin-top: 10px;"></p>
    </div>

    <div class="carnet" id="vista">
        <div class="header">
            <img src="logo_defensa.jpg" alt="Logo">
            <h1>JUNTA DE RETIRO Y FONDO DE PENSIONES<br>FUERZAS ARMADAS</h1>
            <div class="badge" id="v_num">N° --</div>
        </div>
        <div class="body-c">
            <div class="data">
                <label>Rango</label><span id="v_rango">--</span>
                <label>Nombre</label><span id="v_nombre">--</span>
                <label>Cédula</label><span id="v_cedula">--</span>
            </div>
            <div class="qr-box" id="qr"></div>
        </div>
    </div>

    <script>
        // TUS CREDENCIALES REALES
        const sbUrl = 'https://jqmgwaxqdxdozfuvouzz.supabase.co';
        const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpxbWd3YXhxZHhkb3pmdXZvdXp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTYxMDEsImV4cCI6MjA4NTg5MjEwMX0.8pW0kpahzKOODTinKxFrcLmhlDyn7qSwVJv7XERS8K8';
        const _sb = supabase.createClient(sbUrl, sbKey);

        async function generar() {
            const num = document.getElementById('num').value;
            const ran = document.getElementById('rango').value.toUpperCase();
            const nom = document.getElementById('nombre').value.toUpperCase();
            const ced = document.getElementById('cedula').value;
            
            if(!num || !ran || !nom || !ced) return alert("Llena todo");

            // 1. Mostrar visualmente
            document.getElementById('v_num').innerText = "N° " + num;
            document.getElementById('v_rango').innerText = ran;
            document.getElementById('v_nombre').innerText = nom;
            document.getElementById('v_cedula').innerText = ced;
            document.getElementById('vista').style.display = "block";

            // 2. CORRECCIÓN DEL QR (ESTA ES LA CLAVE)
            // window.location.origin obtiene "https://tu-sitio.onrender.com"
            // Le pegamos "/perfil.html" directamente.
            const urlBase = window.location.origin + "/perfil.html"; 
            
            const datos = `?nombre=${encodeURIComponent(nom)}&cedula=${encodeURIComponent(ced)}&rango=${encodeURIComponent(ran)}&num_carnet=${encodeURIComponent(num)}`;
            const linkFinal = urlBase + datos;

            // Debug en consola (F12) para que veas si está bien
            console.log("QR apunta a:", linkFinal);

            const qrDiv = document.getElementById("qr");
            qrDiv.innerHTML = "";
            new QRCode(qrDiv, {
                text: linkFinal,
                width: 100,
                height: 100,
                correctLevel: QRCode.CorrectLevel.L // Nivel bajo para lectura rápida
            });

            // 3. Guardar en Supabase
            const btn = document.getElementById('btn');
            const msg = document.getElementById('msg');
            btn.disabled = true; msg.innerText = "Guardando...";

            const { error } = await _sb.from('registros').insert([{ nombre: nom, cedula: ced, rango: ran, numero_carnet: num }]);

            if(error) {
                console.error(error);
                msg.innerText = "Error guardando (Revisar consola)";
                msg.style.color = "red";
            } else {
                msg.innerText = "¡Guardado Exitosamente!";
                msg.style.color = "green";
            }
            btn.disabled = false;
        }
    </script>
</body>
</html>
